name: Release to Maven Central

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'version.properties'
      - '**.md'
      - 'docs/**'
      - 'media/**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  release:
    env:
      JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      JRELEASER_GPG_PASSPHRASE: ${{ secrets.MAVEN_SIGNING_PASSWORD }}
      JRELEASER_GPG_SECRET_KEY: ${{ secrets.MAVEN_GPG_KEY }}
      JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.MAVEN_GPG_PUBLIC_KEY }}
      JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.MAVEN_USERNAME }}
      JRELEASER_MAVENCENTRAL_TOKEN: ${{ secrets.MAVEN_TOKEN }}

    environment: production

    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Get commit message
        id: commit_message
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "Commit message: $COMMIT_MSG"

      - name: Create secrets.properties
        run: |
          # Create minimal secrets.properties file (credentials are passed via env vars)
          touch secrets.properties
          echo "# Credentials are passed via environment variables" > secrets.properties

      - name: Update version
        id: version
        run: |
          NEW_VERSION=$(./gradlew -q updateVersion -PcommitMessage="${{ steps.commit_message.outputs.message }}" | tail -n 1)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

      - name: Build library
        run: ./gradlew :kwik:assembleRelease --no-daemon --stacktrace

      - name: Publish to staging directory
        run: ./gradlew :kwik:publishAllPublicationsToStagingRepository --no-daemon --stacktrace

      - name: Deploy to Maven Central
        run: ./gradlew jreleaserFullRelease --no-daemon --stacktrace

      - name: Build documentation
        run: ./gradlew :kwik:dokkaGenerate --no-daemon --stacktrace

      - name: Update README.md with new version
        run: |
          sed -i 's/implementation("com.isakaro:kwik.ui:[^"]*")/implementation("com.isakaro:kwik.ui:${{ steps.version.outputs.new_version }}")/' README.md
          echo "Updated README.md to version ${{ steps.version.outputs.new_version }}"

      - name: Configure Git
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "github-actions[bot]"

      - name: Commit and push version changes
        run: |
          git add version.properties README.md
          git commit -m "chore: bump version to ${{ steps.version.outputs.new_version }} [skip ci]"
          git push